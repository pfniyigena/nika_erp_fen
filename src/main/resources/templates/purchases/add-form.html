<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
<th:block th:insert="~{fragments/header :: head}"></th:block>
</head>
<body>
	<th:block th:insert="~{fragments/header :: pre-loader}"></th:block>
	<div id="pcoded" class="pcoded">
		<div class="pcoded-overlay-box"></div>
		<div class="pcoded-container navbar-wrapper">

			<th:block th:insert="~{fragments/header :: navbar-top}"></th:block>

			<div class="pcoded-main-container">
				<div class="pcoded-wrapper">
					<th:block th:insert="~{fragments/header :: navbar-left}"></th:block>

					<div class="pcoded-content">

						<div class="pcoded-inner-content">
							<!-- Main-body start -->
							<div class="main-body">
								<div class="page-wrapper">
									<!-- Page-body start -->
									<div class="page-body">
										<!-- Input Alignment card start -->
										<div class="card">
											<div class="card-header">
												<h5 th:text="#{label.purchase.details}"></h5>
											</div>
											<div class="card-block">
												<form th:action="@{/purchases/new}" th:object="${purchase}"
													method="post">
													<h3>Purchase Lines</h3>
													<table id="lines-table">
														<tr>
															<th>Item</th>
															<th>Quantity</th>
															<th>Unit Price</th>
															<th>Tax Rate</th>
															<th>Line Total</th>
															<th>Action</th>
														</tr>
														<tr th:each="line, iterStat : *{purchaseLines}">
															<td><input type="text"
																th:field="*{purchaseLines[__${iterStat.index}__].itemName}" class="item-search" autocomplete="off"/>
																<div class="suggestions"></div> 
																<input type="hidden"
																th:field="*{purchaseLines[__${iterStat.index}__].itemCode}"
																class="code"/>
																<input type="hidden"
																th:field="*{purchaseLines[__${iterStat.index}__].taxCode}"
																class="tax"/>
																<input type="hidden"
																th:field="*{purchaseLines[__${iterStat.index}__].taxType}"
																class="rate"/>
																</td>
															<td><input type="number"
																th:field="*{purchaseLines[__${iterStat.index}__].quantity}"
																min="0" oninput="updateTotals()"  class="qty"/></td>
															<td><input type="number" step="0.01"
																th:field="*{purchaseLines[__${iterStat.index}__].unitPrice}"
																min="0" oninput="updateTotals()"  class="price"/></td>
															<td><input type="number" step="0.01" 
															    th:field="*{purchaseLines[__${iterStat.index}__].taxType}"  
															    class="rate" readonly/></td>
															
															<td><input type="number" step="0.01"
																name="lineTotal" readonly /></td>
															<td><button type="button" class="btn"
																	onclick="removeLine(this)">Remove</button></td>
														</tr>
													</table>

													<button type="button" class="btn" onclick="addLine()">Add
														Line</button>

													<div class="totals">
														<p>
															Subtotal: <span id="subtotal">0.00</span>
														</p>
														<p>
															Tax: <span id="tax">0.00</span>
														</p>
														<p>
															<strong>Total: <span id="total">0.00</span></strong>
														</p>
													</div>

													<button type="submit">Save purchase</button>
												</form>
											</div>
										</div>
										<!-- Input Alignment card end -->

									</div>
									<!-- Page-body end -->
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<th:block th:insert="~{fragments/header :: footer}"></th:block>
	<script>
	// ðŸ” Auto-search
    $(document).on('keyup', '.item-search', function () {
    	 const $input = $(this);
         const query = $input.val();
         const $suggestions = $input.next('.suggestions');

         if (query.length >= 2) {
             $.get('[[@{/items/search}]]', {query}, function (data) {
                 let list = data.map(item =>
                     `<div class="suggestion" data-id="${item.id}" data-price="${item.price}" data-name="${item.name}" data-code="${item.code}" data-tax="${item.tax}" data-rate="${item.rate}">
                         ${item.name} (${item.rate}-${item.code})
                     </div>`).join('');
                 $suggestions.html(list).show();
             });
         } else {
             $suggestions.hide();
         }
    });	
 // ðŸ§­ Select item
    $(document).on('click', '.suggestion', function () {
        const $div = $(this);
        const $row = $div.closest('td');
        $row.find('.item-search').val($div.data('name'));
        $row.parent().find('.price').val($div.data('price'));
        $row.parent().find('.code').val($div.data('code'));
        $row.parent().find('.tax').val($div.data('tax'));
        $row.parent().find('.rate').val($div.data('rate'));
        $row.parent().find('.qty').val(1);
        $row.find('.suggestions').hide();
        updateTotals();
    });	
let lineIndex = /*[[${purchase.purchaseLines.size()}]]*/ 1;

// Add new line
function addLine() {
    const table = document.getElementById('lines-table');
    const row = table.insertRow();
    row.innerHTML = `
        <td>
        <input type="text" name="purchaseLines[${lineIndex}].itemName" class="item-search" autocomplete="off"/><div class="suggestions"></div>
        <input type="hidden" name="purchaseLines[${lineIndex}].itemCode"  class="code"/>
        <input type="hidden" name="purchaseLines[${lineIndex}].taxCode"  class="tax"/>	
        </td>
        <td><input type="number" name="purchaseLines[${lineIndex}].quantity" min="0" oninput="updateTotals()" class="qty"/></td>
        <td><input type="number" step="0.01" name="purchaseLines[${lineIndex}].unitPrice" min="0" oninput="updateTotals()"  class="price"/></td>
        <td><input type="number" step="0.01" name="purchaseLines[${lineIndex}].taxType"  class="rate" readonly/></td>
        <td><input type="number" step="0.01" name="lineTotal" readonly /></td>
        <td><button type="button" class="btn" onclick="removeLine(this)">Remove</button></td>
    `;
    lineIndex++;
    updateTotals();
}

// Remove line
function removeLine(btn) {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
    updateTotals();
}

// Calculate totals
function updateTotals() {
    const table = document.getElementById('lines-table');
    let total = 0;
    let tax = 0;
    for (let i = 1; i < table.rows.length; i++) {
        const qty = parseFloat(table.rows[i].cells[1].querySelector('input').value) || 0;
        const price = parseFloat(table.rows[i].cells[2].querySelector('input').value) || 0;
        const taxRate = parseFloat(table.rows[i].cells[3].querySelector('input').value) || 0;
        const lineTotal = qty * price;
        const taxPercentage=(taxRate/(100+taxRate)).toFixed(14);
        const lineTax=lineTotal*taxPercentage;
        table.rows[i].cells[4].querySelector('input').value = lineTotal.toFixed(2);
        total += lineTotal;
        tax += lineTax;
        
    }
    //const tax = subtotal * 0.1;
    const subtotal = total - tax;
    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('tax').innerText = tax.toFixed(2);
    document.getElementById('total').innerText = total.toFixed(2);
}

// Initialize totals on page load
updateTotals();
</script>
</body>

</html>
