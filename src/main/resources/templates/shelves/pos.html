<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>MyPOS - Cashier</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
	rel="stylesheet">
<style>
body {
	background: #f8f9fa;
	font-family: 'Segoe UI', sans-serif;
}

.pos-card {
	border-radius: 15px;
	box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.product-item:hover {
	background: #e3f2fd;
	cursor: pointer;
}

.cart-item {
	transition: all 0.2s;
}

.cart-item:hover {
	background: #fff3e0;
}

#barcodeInput:focus {
	outline: none;
	box-shadow: 0 0 0 3px rgba(13, 110, 253, .25);
}

.total-display {
	font-size: 2.5rem;
	font-weight: bold;
	color: #1976d2;
}
</style>
</head>
<body>

	<div class="container-fluid p-4">
		<div class="row g-4">
			<!-- Left: Product Grid + Search -->
			<div class="col-lg-8">
				<div class="card pos-card h-100">
					<div class="card-header bg-primary text-white">
						<h4 class="mb-0">
							<i class="fas fa-cash-register"></i> Point of Sale
						</h4>
					</div>
					<div class="card-body">
						<!-- Search & Barcode -->
						<div class="input-group input-group-lg mb-3">
							<span class="input-group-text"><i class="fas fa-barcode"></i></span>
							<input type="text" id="barcodeInput"
								class="form-control form-control-lg"
								placeholder="Scan barcode or type product name/code..."
								autofocus>
						</div>

						<!-- Product Grid -->
						<div id="productGrid" class="row row-cols-2 row-cols-md-4 g-3"
							style="max-height: 65vh; overflow-y: auto;">
							<div class="col" th:each="product : ${products}">
								<div class="card product-item h-100 text-center p-3"
									th:attr="data-id=${product.internalCode},data-name=${product.itemName},data-price=${product.unitPrice},data-stock=${product.taxValue}"
									th:onclick="addToCart(this)">
									<h6 th:text="${product.itemName}">Item</h6>
									<h5 class="text-primary" th:text="'₹' + ${product.unitPrice}">₹99</h5>
									<small th:text="'Stock: ' + ${product.taxValue}">Stock:
										10</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Right: Cart & Payment -->
			<div class="col-lg-4">
				<div class="card pos-card sticky-top" style="top: 20px;">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0">
							<i class="fas fa-shopping-cart"></i> Current Sale
						</h5>
					</div>
					<div class="card-body">
						<select class="form-select mb-3" id="customerSelect">
							<option value="">Walk-in Customer</option>
							<option th:each="c : ${customers}" th:value="${c.id}"
								th:text="${c.customerName+ ' - ' + c.customerTin}"></option>
						</select>

						<div id="cartItems" style="max-height: 40vh; overflow-y: auto;">
							<!-- Cart items injected by JS -->
						</div>

						<hr>

						<table class="table table-sm">
							<tr>
								<th>Subtotal</th>
								<td id="subtotal">₹0.00</td>
							</tr>
							<tr>
								<th>Discount</th>
								<td><input type="number" id="discount"
									class="form-control form-control-sm" value="0" min="0">
								</td>
							</tr>
							<tr class="table-info">
								<th class="total-display">TOTAL</th>
								<td id="total" class="total-display">₹0.00</td>
							</tr>
						</table>

						<div class="row g-2">
							<div class="col-6">
								<input type="number" id="cashReceived"
									class="form-control form-control-lg text-end"
									placeholder="Cash" step="0.01">
							</div>
							<div class="col-6">
								<button class="btn btn-primary btn-lg w-100"
									onclick="calculateChange()">
									<i class="fas fa-coins"></i> Change
								</button>
							</div>
						</div>
						<h4 class="text-center mt-2 text-success" id="changeDisplay">₹0.00</h4>

						<div class="d-grid gap-2 mt-4">
							<button class="btn btn-success btn-lg"
								onclick="completeSale('CASH')">
								<i class="fas fa-print"></i> Complete & Print (F9)
							</button>
							<button class="btn btn-info btn-lg text-white"
								onclick="completeSale('CARD')">
								<i class="fas fa-credit-card"></i> Card Payment
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script>

    /*<![CDATA[*/
    const cart = [];

    function addToCart(element) {
        const code = element.dataset.id;
        const name = element.dataset.name;
        const price = parseFloat(element.dataset.price);
        const stock = parseInt(element.dataset.stock);

        const existing = cart.find(item => item.code === code);
        if (existing) {
            if (existing.qty >= stock) {
                alert("Out of stock!");
                return;
            }
            existing.qty++;
            existing.total = existing.qty * existing.price;
        } else {
            cart.push({code, name, price, qty: 1, total: price});
        }
        renderCart();
    }

    function renderCart() {
        const cartDiv = document.getElementById('cartItems');
        cartDiv.innerHTML = cart.map((item, index) => `
            <div class="cart-item border rounded p-2 mb-2">
                <div class="d-flex justify-content-between">
                    <strong>${item.name}</strong>
                    <button class="btn btn-sm btn-danger" onclick="cart.splice(${index},1); renderCart();">×</button>
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <input type="number" value="${item.qty}" min="1" max="99"
                           class="form-control form-control-sm w-25" onchange="updateQty(${index}, this.value)">
                    <span>× ₹${item.price.toFixed(2)}</span>
                    <strong>₹${item.total.toFixed(2)}</strong>
                </div>
            </div>
        `).join('');
        calculateTotal();
    }

    function updateQty(index, newQty) {
        if (newQty < 1) newQty = 1;
        cart[index].qty = parseInt(newQty);
        cart[index].total = cart[index].qty * cart[index].price;
        renderCart();
    }

    function calculateTotal() {
        const subtotal = cart.reduce((sum, i) => sum + i.total, 0);
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const total = subtotal - discount;

        document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
        document.getElementById('total').textContent = '₹' + total.toFixed(2);
        return total;
    }

    function calculateChange() {
        const total = calculateTotal();
        const cash = parseFloat(document.getElementById('cashReceived').value) || 0;
        const change = cash - total;
        document.getElementById('changeDisplay').textContent = '₹' + (change >= 0 ? change.toFixed(2) : '0.00');
    }

    async function completeSale(paymentMethod) {
        const total = calculateTotal();
        if (cart.length === 0) return alert("Cart is empty!");

        const receipt = {
            storeName: "My Awesome Shop",
            storeAddress: "123 MG Road, Bangalore",
            storePhone: "+91 98765 43210",
            cashierName: "Rahul",
            dateTime: new Date().toISOString(),
            orderId: "ORD" + Date.now(),
            items: cart.map(i => ({
                description: i.name,
                qty: i.qty,
                unitPrice: i.price,
                total: i.total
            })),
            subTotal: cart.reduce((s,i) => s + i.total, 0),
            discount: parseFloat(document.getElementById('discount').value) || 0,
            total: total,
            cashReceived: parseFloat(document.getElementById('cashReceived').value) || total,
            change: Math.max(0, (parseFloat(document.getElementById('cashReceived').value) || 0) - total),
            customerId: document.getElementById('customerSelect').value || null
        };

        // Print directly to thermal printer
        const response = await fetch('[[@{/shelves/complete-sale}]]', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(receipt)
        });

        if (response.ok) {
            alert("Sale completed & printed!");
            cart.length = 0;
            renderCart();
            document.getElementById('cashReceived').value = '';
            document.getElementById('discount').value = '0';
        } else {
            alert("Print failed!");
        }
    }

    // Barcode scanner support
    let barcodeBuffer = "";
    document.getElementById('barcodeInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            const product = /*[[${products}]]*/[].find(p => p.code === barcodeBuffer || p.description.toLowerCase().includes(barcodeBuffer.toLowerCase()));
            if (product) {
                const mockElement = {
                    dataset: {
                        id: product.code,
                        name: product.description,
                        price: product.unitPrice,
                        stock: product.qtyOnHand
                    }
                };
                addToCart(mockElement);
            }
            barcodeBuffer = "";
            e.target.value = "";
        } else if (e.key.length === 1) {
            barcodeBuffer += e.key;
        }
    });

    // Hotkeys
    document.addEventListener('keydown', e => {
        if (e.key === 'F9') {
            e.preventDefault();
            completeSale('CASH');
        }
    });

    /*]]>*/
</script>
</body>
</html>