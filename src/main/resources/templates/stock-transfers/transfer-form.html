<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head>
<th:block th:insert="~{fragments/header :: head}"></th:block>
<style>
/* Suggestions dropdown (for both desktop and mobile) */
.suggestions {
	position: absolute;
	background-color: #fff;
	border: 1px solid #ccc;
	max-height: 150px;
	overflow-y: auto;
	width: calc(100% - 16px); /* full width of the input minus padding */
	z-index: 1000;
	display: none; /* JS shows/hides it */
	border-radius: 4px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.suggestions div {
	padding: 6px 8px;
	cursor: pointer;
	font-size: 14px;
}

.suggestions div:hover {
	background-color: #f1f1f1;
}

/* Mobile adjustments for stacked cards */
@media ( max-width : 768px) {
	/* Make sure the suggestion dropdown is not cut off */
	.card-block {
		position: relative; /* parent relative for absolute suggestions */
	}
	#lines-table td {
		position: relative; /* make input's parent td relative */
	}
	.suggestions {
		width: 100%; /* match the input width inside card */
		top: 100%; /* position below input */
		left: 0;
	}
}
</style>

</head>
<body>
	<th:block th:insert="~{fragments/header :: pre-loader}"></th:block>
	<div id="pcoded" class="pcoded">
		<div class="pcoded-overlay-box"></div>
		<div class="pcoded-container navbar-wrapper">

			<th:block th:insert="~{fragments/header :: navbar-top}"></th:block>

			<div class="pcoded-main-container">
				<div class="pcoded-wrapper">
					<th:block th:insert="~{fragments/header :: navbar-left}"></th:block>
					<div class="pcoded-content">
						<div class="pcoded-inner-content">
							<!-- Main-body start -->
							<div class="main-body">
								<div class="page-wrapper">
									<!-- Page-body start -->
									<div class="page-body">
										<!-- Success Alert -->
										<div th:if="${success}"
											class="alert alert-success alert-dismissible fade show"
											role="alert">
											<strong th:text="${success}"> </strong>
											<button type="button" class="close" data-dismiss="alert"
												aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>

										<!-- Error Alert -->
										<div th:if="${error}"
											class="alert alert-danger alert-dismissible fade show"
											role="alert">
											<strong th:text="${error}">An error occurred!</strong>
											<button type="button" class="close" data-dismiss="alert"
												aria-label="Close">
												<span aria-hidden="true">&times;</span>
											</button>
										</div>

										<!-- Input Alignment card start -->
										<div class="card">
											<form th:action="@{/stock-transfers/new}"
												th:object="${stockTransferForm}" method="post">
												<div class="card-header">
													<h5>
														<span class="font-weight-bold"
															th:text="#{label.stock.transfer.form.details} + '-'+#{label.general.from}+':' + ${stockTransferForm.fromWarehouseCode} + ' - ' + ${stockTransferForm.fromWarehouseName}"></span>
														<label class="col-sm-4 col-form-label" for="toWarehouseId"
															th:text="#{label.general.to}"></label>
													</h5>
													<div class="form-group row">

														<div class="col-sm-4 has-danger">
															<select th:field="*{toWarehouseId}" required
																class="form-control form-control-bold">
																<option value="">-- Select --</option>
																<option th:each="it : ${warehouses}" th:value="${it.id}"
																	th:text="${it.internalCode}+'-'+${it.warehouseName}">Option</option>
															</select> <span class="col-form-label"
																th:if="${#fields.hasErrors('toWarehouseId')}"
																th:errors="*{toWarehouseId}"></span>
														</div>
													</div>
												</div>
												<div class="card-block">


													<h6 th:text="#{label.shelf.form.line.details}"></h6>
													<input type="hidden" th:field="*{fromWarehouseId}" required /><br />
													<table id="lines-table">
														<tr>
															<th class="font-weight-bold"
																th:text="#{label.general.item}">Item</th>
															<th class="font-weight-bold"
																th:text="#{label.general.quantity}">Quantity</th>
															<th class="font-weight-bold"
																th:text="#{label.general.unitPrice}">Unit Price</th>
															<th class="font-weight-bold" th:text="#{label.tax.rate}">Tax
																Rate</th>
															<th class="font-weight-bold"
																th:text="#{label.general.line.total}">Line Total</th>
															<th class="font-weight-bold"
																th:text="#{label.button.actions}">Action</th>
														</tr>
														<tr th:each="line, iterStat : *{lines}">
															<td><input type="text"
																th:field="*{lines[__${iterStat.index}__].itemName}"
																class="item-search" autocomplete="off" />
																<div class="suggestions"></div> <input type="hidden"
																th:field="*{lines[__${iterStat.index}__].internalCode}"
																class="internalCode" /> <input type="hidden"
																th:field="*{lines[__${iterStat.index}__].taxCode}"
																class="taxCode" /> <input type="hidden"
																th:field="*{lines[__${iterStat.index}__].taxValue}"
																class="taxValue" /></td>
															<td><input type="number"
																th:field="*{lines[__${iterStat.index}__].quantity}"
																min="0" oninput="updateTotals()" class="qty" /></td>
															<td><input type="number" step="0.01"
																th:field="*{lines[__${iterStat.index}__].unitPrice}"
																min="0" oninput="updateTotals()" class="unitPrice" /></td>
															<td><input type="number" step="0.01"
																th:field="*{lines[__${iterStat.index}__].taxValue}"
																class="taxValue" readonly /></td>

															<td><input type="number" step="0.01"
																name="lineTotal" readonly /></td>
															<td><button type="button" class="btn"
																	onclick="removeLine(this)">Remove</button></td>
														</tr>
													</table>

													<button type="button" class="btn" onclick="addLine()">Add
														Line</button>

													<div class="totals">
														<p class="font-weight-bold">
															Subtotal: <span id="subtotal">0.00</span>
														</p>
														<p class="font-weight-bold">
															Tax: <span id="tax">0.00</span>
														</p>
														<p class="font-weight-bold">
															<strong>Total: <span id="total">0.00</span></strong>
														</p>
													</div>

													<button type="submit"
														class="btn btn-success btn-round waves-effect waves-light"
														th:text="#{label.button.transfer.stock}">Transfer</button>

												</div>
											</form>
										</div>
										<!-- Input Alignment card end -->

									</div>
									<!-- Page-body end -->
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<th:block th:insert="~{fragments/header :: footer}"></th:block>
	<script>
	setTimeout(function() {
	      $(".alert").alert('close');
	    }, 1000); // 1 seconds
	// ðŸ” Auto-search
    $(document).on('keyup', '.item-search', function () {
    	 const $input = $(this);
         const query = $input.val();
         const $suggestions = $input.next('.suggestions');

         if (query.length >= 2) {
             $.get('[[@{/items/search}]]', {query}, function (data) {
                 let list = data.map(item =>
                     `<div class="suggestion" data-id="${item.id}" data-unit-price="${item.unitPrice}" data-item-name="${item.itemName}" data-internal-code="${item.internalCode}" data-tax-code="${item.taxCode}" data-tax-rate="${item.taxValue}">
                         ${item.itemName} (${item.taxValue}-${item.internalCode})
                     </div>`).join('');
                 $suggestions.html(list).show();
             });
         } else {
             $suggestions.hide();
         }
    });	
 // ðŸ§­ Select item
    $(document).on('click', '.suggestion', function () {
        const $div = $(this);
        const $row = $div.closest('td');
        $row.find('.item-search').val($div.data('item-name'));
        $row.parent().find('.unitPrice').val($div.data('unit-price'));
        $row.parent().find('.internalCode').val($div.data('internal-code'));
        $row.parent().find('.taxCode').val($div.data('tax-code'));
        $row.parent().find('.taxValue').val($div.data('tax-rate'));
        $row.parent().find('.qty').val(1);
        $row.find('.suggestions').hide();
        updateTotals();
    });	
let lineIndex = /*[[${stockTransferForm.lines.size()}]]*/ 1;

// Add new line
function addLine() {
    const table = document.getElementById('lines-table');
    const row = table.insertRow();
    row.innerHTML = `
        <td>
        <input type="text" name="lines[${lineIndex}].itemName" class="item-search" autocomplete="off"/><div class="suggestions"></div>
        <input type="hidden" name="lines[${lineIndex}].internalCode"  class="internalCode"/>
        <input type="hidden" name="lines[${lineIndex}].taxCode"  class="taxCode"/>	
        	<input type="hidden" name="lines[${lineIndex}].taxValue"  class="taxValue"/>	
        </td>
        <td><input type="number" name="lines[${lineIndex}].quantity" min="0" oninput="updateTotals()" class="qty"/></td>
        <td><input type="number" step="0.01" name="lines[${lineIndex}].unitPrice" min="0" oninput="updateTotals()"  class="unitPrice"/></td>
        <td><input type="number" step="0.01" name="lines[${lineIndex}].taxType"  class="taxValue" readonly/></td>
        <td><input type="number" step="0.01" name="lineTotal" readonly /></td>
        <td><button type="button" class="btn" onclick="removeLine(this)">Remove</button></td>
    `;
    lineIndex++;
    updateTotals();
}

// Remove line
function removeLine(btn) {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
    updateTotals();
}

// Calculate totals
function updateTotals() {
    const table = document.getElementById('lines-table');
    let total = 0;
    let tax = 0;
    for (let i = 1; i < table.rows.length; i++) {
        const qty = parseFloat(table.rows[i].cells[1].querySelector('input').value) || 0;
        const price = parseFloat(table.rows[i].cells[2].querySelector('input').value) || 0;
        const taxRate = parseFloat(table.rows[i].cells[3].querySelector('input').value) || 0;
        const lineTotal = qty * price;
        const taxPercentage=(taxRate/(100+taxRate)).toFixed(14);
        const lineTax=lineTotal*taxPercentage;
        table.rows[i].cells[4].querySelector('input').value = lineTotal.toFixed(2);
        total += lineTotal;
        tax += lineTax;
        
    }
    //const tax = subtotal * 0.1;
    const subtotal = total - tax;
    document.getElementById('subtotal').innerText = subtotal.toFixed(2);
    document.getElementById('tax').innerText = tax.toFixed(2);
    document.getElementById('total').innerText = total.toFixed(2);
}

// Initialize totals on page load
updateTotals();
</script>
</body>

</html>
